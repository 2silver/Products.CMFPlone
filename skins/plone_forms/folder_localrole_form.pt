<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

<metal:block fill-slot="top_slot"
             tal:define="dummy python:request.set('enable_border',1)" />

<body>

  <div metal:fill-slot="main"

       tal:define="Batch python:modules['Products.CMFPlone'].Batch;
                   username member/getUserName;
                   avail_roles python:[role for role in container.portal_membership.getCandidateLocalRoles(here) if role!='Owner'];
                   group_submit request/group_submit|nothing;
                   b_size python:12;b_start python:0;b_start request/b_start | b_start;
                   tabindex python:Iterator();
                   iscontainer here/isPrincipiaFolderish|nothing;
                   inheritanceActive python:putils.isLocalRoleAcquired(here);
                   search_submitted request/role_submit|nothing;
                   search_results python:search_submitted and mtool.searchForMembers(
                                         {request.get('search_param',''):
                                         request.get('search_term', '')}) or None;">

    <div metal:use-macro="here/document_actions/macros/document_actions">
        Document actions (print, sendto etc)
    </div>

    <h1 i18n:translate="heading_currently_assigned_shares">
        Current sharing permissions for
        <span tal:content="here/title_or_id" i18n:name="folder">title</span>
    </h1>

    <p i18n:translate="description_share_folders_items_current_shares">
        You can share the rights for both folders (including content) and single items.
        These users have privileges here:
    </p>


    <tal:warning tal:condition="not:iscontainer">
        <div class="portalMessage" style="background-color:rgb(255,191,191)">
            <span style="font-weight:normal" i18n:translate="local_role_warning"><strong>Attention!</strong> You are setting the sharing permissions for a <strong tal:content="here/portal_type"/>.
            If you want to set the permissions for its containing folder, click
            <a href="" tal:attributes="href python:here.absolute_url()+'/../'+ template.id">here</a>
            </span>.
        </div>
    </tal:warning>


    <tal:warning tal:condition="python:iscontainer and here.isDefaultPageInFolder()">
        <div class="portalMessage" style="background-color:rgb(255,191,191)">
            <span style="font-weight:normal" i18n:translate="local_role_warning"><strong>Attention!</strong> You are setting the sharing permissions for this folder's default page.
            If you want to set the permissions for its containing folder, click
            <a href="" tal:attributes="href python:here.absolute_url()+'/../'+ template.id">here</a>
            </span>.
        </div>
    </tal:warning>

<form method="post"
          name="setacquisition"
          action="folder_localrole_set">

      <fieldset>

        <legend i18n:translate="legend_security_settings">
            Advanced Settings
        </legend>

        <div class="field">
            <input class="noborder" type="checkbox" name="use_acquisition:int" value="1" id="inherit"
                tal:attributes="checked     python:test(inheritanceActive,1,None)"
                /> 
            <label for="inherit">Inherit roles from higher levels </label>
            <div class="formHelp" i18n:translate="help_use_acquisition">
                Determines if the roles given to users and groups from higher levels are in
                effect in this context.
            </div>
        </div>

        <div class="submit">
            <input class="context"
                type="submit"
                value="Apply Settings"
                i18n:attributes="value"
                tabindex=""
                tal:attributes="tabindex tabindex/next;"
                />
        </div>

      </fieldset>
    </form>

    <!-- form for changing existing roles -->
    <form method="post"
          name="deleterole"
          action="folder_localrole_delete"
          tal:attributes="action string:$here_url">

      <fieldset>

        <legend i18n:translate="legend_assigned_roles">
            Assigned Roles
            <span tal:content="here/title_or_id" i18n:name="folder">title</span>
        </legend>

        <input type="hidden" name="change_type" value="delete" />
        <input type="hidden" name="member_role" value="" />

        <table class="listing" summary="Currently assigned local roles" tal:define="showPortraits python:1">
            <thead>
            <tr>
                <th>
                    <input type="checkbox"
                       onclick="javascript:toggleSelect(this, 'member_ids:list', false, 'deleterole');"
                       name="alr_toggle"
                       value="#"
                       id="alr_toggle"
                       class="noborder"
                       tabindex=""
                       tal:attributes="tabindex tabindex/next;"/>
                </th>
                <th i18n:translate="label_name">Name</th>
                <th i18n:translate="label_type">Type</th>

                <th class="" 
                    tal:attributes="class   python:test(inheritanceActive,'','noInheritedRoles')">
                    <span i18n:translate="label_acquired_roles" nowrap="nowrap">Inherited Role(s)</span>
                    <span tal:condition="not:inheritanceActive" i18n:translate="label_acquired_roles_inactive" nowrap="nowrap">(inactive)</span>
                </th>
                <th i18n:translate="label_local_roles" nowrap="nowrap">Local Role(s)</th>
            </tr>
            </thead>
            <tbody>
            <tal:repeat tal:repeat="entry here/computeRoleMap">
        <tr tal:define="oddrow      repeat/entry/odd;
                              isGroup   python:entry['type']=='group';"
            tal:attributes="class python:test(oddrow,'even','odd');">
                <td valign="top" class="field">
                    <label class="hiddenLabel" for="member_ids:list"
                           i18n:translate="label_select_usergroup">
                        select user/group <span tal:content="entry/id" i18n:name="role"/>
                    </label>
                    <input class="formSelection"
                           type="checkbox"
                           name="member_ids:list"
                           id="#"
                           value=""
                           tabindex=""
                           tal:condition="python:entry['name']!=username"
                           tal:attributes="value entry/id;
                                           tabindex tabindex/next"
                           />
                </td>

                <td valign="top" tal:condition="not: isGroup">
                        <img src=""
                                 tal:condition="not: showPortraits"
                                 tal:replace="structure portal/user.gif;" />
           
                        <img tal:replace="structure here/user.gif" />
                        <span tal:replace="entry/name">
                                    username
                        </span>
                </td>
                <td valign="top" tal:condition="isGroup">
                        <img tal:replace="structure here/group.gif" />
                        <span tal:replace="entry/name">
                                    groupname
                        </span>
                </td>

                <td valign="top" tal:condition="isGroup"
                    i18n:translate="label_group">
                    Group
                </td>
                <td valign="top" tal:condition="not: isGroup"
                    i18n:translate="label_user">
                    User
                </td>

                <td valign="top" 
                    tal:attributes="class   python:test(inheritanceActive,'','noInheritedRoles')">
                <tal:block tal:repeat="role entry/acquired">
                    <span i18n:translate=""
                          tal:content="role"
                          tal:omit-tag="">Role</span>
                     <span tal:omit-tag=""
                           tal:condition="not: repeat/role/end">,</span>
                    <br />
                </tal:block>
                </td>

                <td valign="top">
                <tal:block tal:repeat="role entry/local">
            <input tal:condition="python:role!='Owner'" type="checkbox" 
                name="member_role_ids:list"
                value=""
                tal:attributes="value   string:${entry/id}((${role}))"
                />
                    <span i18n:translate=""
                          tal:content="role"
                          tal:omit-tag="">Role</span>
                    <span tal:condition="not: repeat/role/end"
                          tal:omit-tag=""> </span><br />
                </tal:block>
                </td>
            </tr>
        </tal:repeat>
            </tbody>
        </table>

        <div class="label" i18n:translate="label_localroles_to_assign_to_selected_users">Roles to assign to selected user(s)/group(s)</div>

        <div class="field"
             tal:define="data    python:here.formatColumns(avail_roles);">
            <table cellspacing="3">
                <tr tal:repeat="row     data">
                    <td tal:repeat="lrole row">
                        <input type="checkbox" name="member_roles:list" 
                                tal:condition="lrole"
                                tal:attributes="tabindex tabindex/next;
                                                value lrole"/>
                        <span tal:condition="lrole" 
                              i18n:translate=""
                              tal:content="lrole">role</span>
                    </td>
                </tr>
            </table>
        </div>

        <div class="submit">
	    <input class="context"
		type="submit"
		value="Assign Selected Role(s) to Selected User(s)/Group(s)"
		name="folder_localrole_add:method"
		i18n:attributes="value"
		tabindex=""
		tal:attributes="tabindex tabindex/next;"
		/>
            <input class="destructive"
                type="submit"
                value="Delete Selected Role(s) and User(s)/Group(s)"
                name="folder_localrole_delete:method"
                i18n:attributes="value"
                tabindex=""
                tal:attributes="tabindex tabindex/next;"
                />
        </div>

        </fieldset>

    </form>

    <metal:block tal:condition="python:test(search_submitted and not search_results, 1, 0)">
        <h1 i18n:translate="heading_search_results">Search results</h1>
        <p i18n:translate="no_members_found">
            No members were found using your <strong>Search Criteria</strong>
        </p>
        <hr />
    </metal:block>

    <metal:block tal:condition="python:test(search_submitted and search_results, 1, 0)">

        <h1 i18n:translate="heading_search_results">Search results</h1>

        <p i18n:translate="description_localrole_select_member">
            Select one or more people, and a role to assign.
        </p>

        <metal:block tal:define="batch python:Batch(search_results, b_size, int(b_start), orphan=3);
                                 nResults python:len(search_results);">

        <form method="post"
              name="change_type"
              action="folder_localrole_edit"
              tal:attributes="action string:$here_url/folder_localrole_edit">

            <fieldset>

                <legend i18n:translate="legend_available_members">Available Members</legend>

                <input type="hidden" name="change_type" value="add" />

                <!-- batch navigation -->
                <div metal:use-macro="here/batch_macros/macros/navigation" />

                <table class="listing" summary="Search results">
                    <thead>
                    <tr>
                        <th>
                            <input type="checkbox"
                               onclick="javascript:toggleSelect(this, 'member_ids:list', false, 'change_type');"
                               name="alr_toggle"
                               value="#"
                               id="alr_toggle"
                               class="noborder"
                               tabindex=""
                               tal:attributes="tabindex tabindex/next;"/>
                        </th>
                        <th i18n:translate="label_user_name">User Name</th>
                        <th i18n:translate="label_email_address">Email Address</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr tal:repeat="member batch">
                        <td class="field" tal:define="member_name member/getUserName;
                                                      member_id member/getId">
                            <label class="hiddenLabel" for="member_ids:list"
                                   i18n:translate="label_select_user">
                                select user <span tal:content="member_name" i18n:name="user" />
                            </label>
                            <input class="formSelection"
                                   type="checkbox"
                                   name="member_ids:list"
                                   id="#"
                                   value=""
                                   tabindex=""
                                   tal:attributes="value member_id;
                                                   checked python:nResults==1;
                                                   tabindex tabindex/next;"
                            />
                        </td>

                        <td tal:content="member/getUserName">username</td>
                        <td tal:content="member/email">email</td>
                    </tr>
                    </tbody>
                </table>

                <!-- batch navigation -->
                <div metal:use-macro="here/batch_macros/macros/navigation" />

                <div class="field">

                    <label for="user_member_role" i18n:translate="label_localrole_to_assign">
                        Role to assign
                    </label>

                    <select name="member_role:list"
                            id="user_member_role"
                            multiple="multiple"
                            tabindex=""
                            tal:attributes="tabindex tabindex/next;">
                        <option tal:repeat="lroles python:mtool.getCandidateLocalRoles(here)"
                                tal:attributes="value lroles"
                                tal:content="lroles"
                                i18n:translate="">
                            Role name
                        </option>
                    </select>

                </div>

                <div class="submit">
                    <input class="context"
                            type="submit"
                            value="Assign Local Role to Selected User(s)"
                            i18n:attributes="value"
                            tabindex=""
                            tal:attributes="tabindex tabindex/next;"
                            />
                </div>

            </fieldset>

        </form>

      </metal:block>
    </metal:block>

    <div>
      <tal:block tal:condition="python: (not search_submitted or
                                        (search_submitted and not search_results))">

        <h1 i18n:translate="heading_add_sharing_permissions">
          Add sharing permissions for
          <tal:block tal:content="here/title_or_id" i18n:name="item">title</tal:block>
        </h1>


        <p i18n:translate="description_sharing_item">
        Sharing is an easy way to allow others access to collaborate with you
        on your content.

        To share this item, search for the person's
        name or email address in the form below, and assign them an appropriate role.
        The most common use is to give people Manager permissions, which means they
        have full control of this item and its contents (if any).
        </p>

        <form method="post"
              name="localrole"
              action="folder_localrole_form"
              tal:attributes="action string:$here_url/${template/getId}" >

            <fieldset>

                <legend i18n:translate="legend_search_terms">Search Terms</legend>

                <input type="hidden" name="role_submit" value="role_submit" />

                <div class="field">
                    <label for="search_param" i18n:translate="label_search_by">
                        Search by
                    </label>

                    <select name="search_param"
                            id="search_param"
                            tabindex=""
                            tal:attributes="tabindex tabindex/next;">
                        <option value="name" i18n:translate="label_user_name">
                            User Name
                        </option>
                        <option value="email" i18n:translate="label_email_address">
                            Email Address
                        </option>
                        <option value="groupname" i18n:translate="label_group_name">
                            Group Name
                        </option>
                    </select>

                </div>

                <div class="field">
                    <label for="search_term" i18n:translate="label_search_term">
                        Search Term
                    </label>

                    <input type="text"
                            id="search_term"
                            name="search_term"
                            size="30"
                            tabindex=""
                            tal:attributes="tabindex tabindex/next;"
                            />
                </div>

                <div class="submit">
                    <input class="context"
                            type="submit"
                            value="Perform Search"
                            i18n:attributes="value"
                            tabindex=""
                            tal:attributes="tabindex tabindex/next;"
                            />
                </div>

            </fieldset>

        </form>
      </tal:block>

      <tal:groupshares define="grouplist gtool/listGroups"
                       condition="grouplist">

          <h1 i18n:translate="heading_group_shares">Add sharing permissions to groups</h1>

          <p i18n:translate="description_group_shares">
            Groups are a convenient way to share items to a common set of
            users. Select one or more groups, and a role to assign.
          </p>

          <form method="post"
                name="change_type_group"
                action="folder_localrole_edit"
                tal:attributes="action string:$here_url/folder_localrole_edit">

            <fieldset>

                    <legend i18n:translate="legend_available_groups">
                        Available Groups
                    </legend>

                    <input type="hidden" name="change_type" value="add" />

                    <table class="listing" summary="Available groups">
                    <thead>
                        <tr>
                        <th>
                            <input type="checkbox"
                               onclick="javascript:toggleSelect(this, 'member_ids:list', false, 'change_type_group');"
                               name="alr_toggle"
                               value="#"
                               id="alr_toggle"
                               class="noborder"
                               tabindex=""
                               tal:attributes="tabindex tabindex/next;"/>
                        </th>
                        <th i18n:translate="listingheader_name">Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr tal:repeat="group grouplist">
                        <td tal:define="group_name group/getUserName;
                                        group_id group/getId;">
                            <label class="hiddenLabel" for="member_ids:list"
                                   i18n:translate="label_select_group">
                                select group <span tal:content="group_name" i18n:name="name"/>
                            </label>
                            <input class="formSelection"
                                type="checkbox"
                                name="member_ids:list"
                                id="#"
                                value=""
                                tabindex=""
                                tal:attributes="value group_id;
                                                tabindex tabindex/next;"/>
                        </td>
                        <td tal:content="group/getUserNameWithoutGroupPrefix">
                            groupname
                        </td>
                        </tr>
                    </tbody>
                    </table>

                    <div class="field">

                        <label for="group_member_role" i18n:translate="label_localrole_to_assign">
                            Role to assign
                        </label>

                        <select name="member_role:list"
                                id="group_member_role"
                                multiple="multiple"
                                tabindex=""
                                tal:attributes="tabindex tabindex/next;">
                            <option tal:repeat="lroles python:mtool.getCandidateLocalRoles(here)"
                                    tal:attributes="value lroles"
                                    tal:content="lroles"
                                    i18n:translate="">
                                Role name
                            </option>
                        </select>
                    </div>

                    <div class="submit">
                        <input class="context"
                            type="submit"
                            value="Assign Local Role to Selected Group(s)"
                            i18n:attributes="value"
                            tabindex=""
                            tal:attributes="tabindex tabindex/next;"
                            />
                    </div>

                </fieldset>

            </form>

        </tal:groupshares>

    

      <div metal:use-macro="here/document_byline/macros/byline">
        Get the byline - contains details about author and modification date.
      </div>

    </div>

  </div>

</body>
</html>
