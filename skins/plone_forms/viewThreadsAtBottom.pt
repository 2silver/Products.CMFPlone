<div metal:define-macro="discussionView"
    tal:define="isDiscussionAllowed python:request.get('discussion_allowed', container.portal_discussion.isDiscussionAllowedFor(here));
                hereTypeInfo python:request.get('this_typeinfo', here.getTypeInfo());
                view_action python:hereTypeInfo.getActionById('view');
                isViewTemplate python:test(template.getId()==view_action, 1, 0);
     ">
    <div tal:condition="python:test( isDiscussionAllowed and isViewTemplate , 1, 0)">
    <metal:block tal:condition="isDiscussionAllowed"> 
      <tal tal:define="global discussion python:here.portal_discussion.getDiscussionFor(here)" />
    </metal:block>

    <form name="reply" 
          action="" 
          method="post"
          tal:condition="isDiscussionAllowed" 
	  tal:attributes="action string:${here/absolute_url}/discussion_reply_form">       	

        <input class="standalone" 
	       type="submit" 
	       value="Add Comment"
           i18n:attributes="value"
           />
    </form>
    
    <div tal:condition="python:here.portal_discussion.isDiscussionAllowedFor(here)"
	 tal:define="stx python:modules['Products.PythonScripts.standard'].structured_text">
	<a name="comments"> </a>
	<div tal:repeat="reply python:container.sort_modified_ascending(here.talkback.getReplies())">

	    <table class="box"
		   cellpadding="0"
		   cellspacing="0">
		<tr>
		    <th i18n:translate="listingheader_comment">Comment</th><th class="empty">&nbsp;</th>	
		</tr>
		
		<tr>
		    <td colspan="2">
			<h2><img tal:replace="structure here/discussionitem_icon.gif" /> <span tal:replace="reply/title_or_id">Comment title</span> </h2>
			<span i18n:translate="label_comment_by">Posted by</span>:
			<span tal:content="reply/Creator">Poster Name</span>
			<span i18n:translate="label_commented_at">at</span> 
			<span tal:replace="python: here.toPortalTime(reply.modified())">8/23/2001 12:40:44 PM</span>
			
			<p tal:content="structure python:stx(reply.text)">
				This is the body text of the comment. 
				</p>
			
			<form name="reply"
			      action="discussion_reply_form"
			      method="post"
			      tal:condition="python:test( getattr(here, 'isPortalContent', ''), here.isPortalContent, 0)" 
			      tal:attributes="action string:${reply/absolute_url}/discussion_reply_form" >
			      
			    <input class="standalone" 
                       type="submit" 
                       value="Reply to this" 
                       i18n:attributes="value"
                       />
			
			</form>
		    
            <a href="" 
               tal:condition="python:here.portal_membership.checkPermission('Manage portal', here)"
               tal:attributes="href string:${reply/absolute_url}/deleteDiscussion">
            Remove this discussion
            </a>

            <div tal:define="crap python:request.set('searchForRepliesTo', reply)"></div>
            <tal metal:use-macro="here/viewThreadsAtBottom/macros/repliesView" />
		    </td>
		</tr>
	    </table>
	    
	</div>
    </div>
    
</div>
</div>


<div metal:define-macro="repliesView">
			<div class="group" tal:condition="python: here.talkback.hasReplies(request.get('searchForRepliesTo', ''))">
			    <span class="legend">Replies</span>

			    <span> 
				 <span tal:repeat="child python:container.sort_modified_ascending(request.get('searchForRepliesTo', None).talkback.getReplies())">
				    <a href="" 
				       class="comment" 
				       tal:attributes="href string:${child/absolute_url}/discussionitem_view">
				    <span tal:replace="child/Title">Comment title</span>   
				    (<span i18n:translate="label_comment_by">Posted by</span> 
                    <span tal:replace="child/Creator">username</span>
				    <span i18n:translate="label_commented_at">at</span> 
                    <span tal:replace="python: here.toPortalTime(child.modified())">8/23/2001 12:49:08 PM</span>)
				    </a>

                    &nbsp;

                    <a href=""
                       tal:condition="python:here.portal_membership.checkPermission('Manage portal', here)"
                       tal:attributes="href string:${child/absolute_url}/deleteDiscussion" >
                       Delete this comment
                    </a>
            
                   
            <div tal:define="crap python:request.set('searchForRepliesTo', child)"></div>
            <div tal:condition="python: here.talkback.hasReplies(request.get('searchForRepliesTo', ''))">
            <tal metal:use-macro="here/viewThreadsAtBottom/macros/repliesView" />
            </div>
			
                   </span>
			    </span>
			</div>
</div>
