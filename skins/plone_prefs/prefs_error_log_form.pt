<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="here/prefs_main_template/macros/master"
      i18n:domain="plone">

<tal:block metal:fill-slot="head_slot">
   <tal:block tal:define="dummy python:request.set('disable_border',1)" />
</tal:block>

<body>

<div metal:fill-slot="prefs_configlet_main">

    <h1 i18n:translate="heading_error_log">Error log</h1>
         
    <a href=""
       class="link-parent"
       tal:attributes="href string: $portal_url/plone_control_panel"
       i18n:translate="label_up_to_plone_setup">
    Up to Plone Setup
    </a>

    <p i18n:translate="description_error_log_setup">
        This page lists the exceptions that have occurred in this site
        recently.  You can configure how many exceptions should be kept
        and whether the exceptions should be copied to Zope's event log
        file(s).
    </p>

        <form action="prefs_error_log_update" method="get">
        
            <fieldset tal:define="entries here/error_log/getLogEntries">
            
                <legend i18n:translate="legend_logexception">Exception Log (most recent first)</legend>
        
                <div class="field" tal:condition="not:entries" i18n:translate="legend_lognoexceptions">
                No exceptions logged.
                </div>

                <div class="formControls">
                    <input class="standalone" type="submit" name="submit" value="Refresh" i18n:attributes="value" />
                    <input class="standalone" type="submit" name="submit" value="Clear Displayed Entries" i18n:attributes="value" />
                    <input class="standalone" type="submit" name="submit" value="Show all entries" i18n:attributes="value" />
                </div>

                <table class="listing"
                       id="sortable"
                       summary="Exception Log (most recent first)"
                       i18n:attributes="summary"
                       tal:condition="entries">
                    <thead>
                        <tr>
                            <th i18n:translate="label_time">Time</th>
                            <th i18n:translate="label_user_name">User Name</th>
                            <th i18n:translate="label_exception">Exception</th>
                        </tr>
                    </thead>

                    <tbody tal:define="updatetime python:float(member.getProperty('error_log_update', 0.0))">
                        
                        <tal:entry tal:repeat="entry entries">
                        <tr tal:define="oddrow repeat/entry/odd;"
                            tal:attributes="class python:test(oddrow, 'even', 'odd')"
                            tal:condition="python: test(entry['time'] > updatetime,1,0)">
                        
                            <td tal:content="python: DateTime(entry['time'])">13:04:41</td>
                            <td tal:content="string: ${entry/username} (${entry/userid})">joe</td>
                            <td>
                                <a href="showEntry" tal:attributes="href string:prefs_error_log_showEntry?id=${entry/id}">
                                    <span tal:replace="entry/type">AttributeError</span>:
                                    <span tal:define="value entry/value"
                                          tal:content="python: len(value) &lt; 70 and value or value[:70] + '...'">
                                    Application object has no attribute "gak"
                                    </span>
                                </a>
                            </td>
                        </tr>
                        </tal:entry>
                    </tbody>
                </table>
                
            </fieldset>
        </form>

    <form action="prefs_error_log_setProperties" method="post">
    
        <fieldset tal:define="props here/error_log/getProperties">
        
            <legend i18n:translate="legend_logdetails">Log details</legend>

            <div class="field">
                <label i18n:translate="label_number_exceptions">Number of exceptions to keep</label>

                <div></div>
                
                <input type="text" 
                       name="keep_entries" 
                       size="40"
                       tal:attributes="value props/keep_entries" />
            </div>
            
            <div class="field">
                <input type="checkbox"
                       class="noborder"
                       id="cb_copy_to_zlog" 
                       name="copy_to_zlog"
                       tal:attributes="checked props/copy_to_zlog;
                                       disabled not:here/error_log/checkEventLogPermission|nothing" />

                <label for="cb_copy_to_zlog" i18n:translate="label_copy_exceptions">Copy exceptions to the event log</label>
                
            </div>
                                       
            <div class="field">
                <label i18n:translate="label_ignored_exception">Ignored exception types</label>
                
                <textarea name="ignored_exceptions:lines" 
                          cols="40" rows="3"
                          tal:content="python: '\n'.join(props['ignored_exceptions'])"></textarea>
            </div>
            
            <div class="formControls">
                <input class="context" 
                       type="submit" 
                       name="submit" 
                       value="Save"
                       i18n:attributes="value" />
            </div>

            </fieldset>

        </form>

    </div>
    
</body>
</html>
