<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="here/prefs_main_template/macros/master"
      i18n:domain="plone">

<tal:block metal:fill-slot="head_slot">
   <tal:block tal:define="dummy python:request.set('disable_border',1)" />
</tal:block>

<body>

<div metal:fill-slot="main"
         tal:condition="here/rejectAnonymous" >

    <p i18n:translate="description_error_log_setup" class="form-help">
    This page lists the exceptions that have occurred in this site
    recently.  You can configure how many exceptions should be kept
    and whether the exceptions should be copied to Zope's event log
    file(s).
    </p>

    <form class="group" action="prefs_error_log_setProperties" method="post">
        <table tal:define="props here/error_log/getProperties">
            <tr>
                <td align="left" valign="top">
                    <div class="form-label">
                        <span i18n:translate="label_number_exceptions">Number of exceptions to keep</span>
                    </div>
                </td>
                <td align="left" valign="top">
                    <input type="text" name="keep_entries" size="40"
                        tal:attributes="value props/keep_entries" />
                </td>
            </tr>
            <tr>
                <td align="left" valign="top">
                    <div class="form-label">
                        <span i18n:translate="label_copy_exceptions">Copy exceptions to the event log</span>
                    </div>
                </td>
                <td align="left" valign="top">
                    <input type="checkbox" name="copy_to_zlog"
                          tal:attributes="checked props/copy_to_zlog;
                          disabled not:here/error_log/checkEventLogPermission|nothing" />
                </td>
            </tr>
            <tr>
                <td align="left" valign="top">
                    <div class="form-label">
                        <span i18n:translate="label_ignored_exception">Ignored exception types</span>
                    </div>
                </td>
                <td align="left" valign="top">
                    <textarea name="ignored_exceptions:lines" cols="40" rows="3"
                          tal:content="python: '\n'.join(props['ignored_exceptions'])">
                    </textarea>
                </td>
            </tr>
            <tr>
                <td align="left" valign="top">
                </td>
                <td align="left" valign="top">
                    <div class="form-element">
                        <input class="form-element" type="submit" name="submit"
                              value=" Save Changes " />
                    </div>
                </td>
            </tr>
        </table>

        <h3>Exception Log (most recent first)</h3>

        <div tal:define="entries here/error_log/getLogEntries">

            <em tal:condition="not:entries">
                <span i18n:translate=""> No exceptions logged.</span>
            </em>

            <table tal:condition="entries">
                <tr>
                    <th align="left">
                        <span i18n:translate="">Time</span>
                    </th>
                    <th align="left">
                        <span i18n:translate="">Username (User Id)</span>
                    </th>
                    <th align="left">
                        <span i18n:translate="">Exception</span>
                    </th>
                </tr>

                <div tal:define="updatetime python:float(member.getProperty('error_log_update',''))">

                    <tr tal:repeat="entry entries">
                        <div tal:condition="python: test(entry['time'] > updatetime,1,0)">
                            <td valign="top" nowrap="nowrap">
                                <span tal:content="python: DateTime(entry['time']).Date()">13:04:41</span>
                            </td>
                            <td>
                                <span tal:content="string: ${entry/username} (${entry/userid})">
                                    joe (joe)
                                </span>
                            </td>
                            <td valign="top">
                                <a href="showEntry" tal:attributes="href string:prefs_error_log_showEntry?id=${entry/id}">
                                <span tal:content="entry/type">AttributeError</span>:
                                <span tal:define="value entry/value"
                                    tal:content="python: len(value) < 70 and value or value[:70] + '...'">
                                    Application object has no attribute "zzope"
                                </span>
                                </a>
                            </td>
                        </div>
                    </tr>
                </div>
            </table>
        </div>
    </form>
    <p>
        <form action="prefs_error_log_update" method="GET">
            <input type="submit" name="submit" value=" Refresh " i18n:attributes="value" />
            <input type="submit" name="submit" value=" I'm up to date " i18n:attributes="value" />
            <input type="submit" name="submit" value=" Show all entries " i18n:attributes="value" />
        </form>
    </p>
</div>

</body>
</html>