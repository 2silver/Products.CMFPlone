<div metal:define-macro="calendarBox"
     class="container"
     tal:define="DateTime python:modules['DateTime'].DateTime;
                 current python:DateTime();
                 month python:request.get('month', DateTime().month());
                 year python:request.get('year', DateTime().year());
                 prevMonthTime python:here.getPreviousMonth(month, year);
                 nextMonthTime python:here.getNextMonth(month, year);
                 weeks python:here.portal_calendar.getEventsForCalendar(month=month, year=year);">
    <!-- The calendar, rendered as a table -->

    <table cellpadding="2" cellspacing="0" border="0" class="calendar" id="thecalendar">

        <tr>
            <th>
                <a href="#" tal:attributes="href python:'%s?month:int=%d&year:int=%d' % (here.absolute_url()+'/'+template.getId(),prevMonthTime.month(),prevMonthTime.year())">&laquo;</a>
            </th>

            <th colspan="5" tal:define="date string:$month/1/$year">
              <span tal:replace="python:DateTime(date).strftime('%B').capitalize()"/> <span tal:replace="python:DateTime(date).year()"/>
            </th>

            <th>
                <a href="#" tal:attributes="href python:'%s?month:int=%d&year:int=%d' % (here.absolute_url()+'/'+template.getId(),nextMonthTime.month(),nextMonthTime.year())">&raquo;</a>
            </th>

        <tr tal:define="weekdays here/portal_calendar/getDays">
          <metal:block tal:repeat="weekday weekdays">
            <td class="weekdays" tal:content="weekday">Su</td>
          </metal:block>
        </tr>

            <tr tal:repeat="week weeks">
              <metal:block tal:define="days week">
                <metal:block tal:repeat="day days">
                  <metal:block tal:condition="day/event">
                  <metal:block tal:define="daynumber day/day;
                                           datestring python: '%d%0.2d%0.2d' % (year, month, daynumber);
                                           javascriptstring string:javascript:%sDay('%s');;">
                  <td class="event"
                      tal:attributes="onMouseOut  python: javascriptstring % ('hide', datestring);
                                      onMouseOver python: javascriptstring % ('show', datestring);
                                      class       python:test(current.year()==year and current.month()==month and current.day()==int(daynumber), 'todayevent', 'event')">
                    <span tal:define="begEndTimes python:here.getBeginAndEndTimes(day=day['day'], month=month, year=year)" tal:omit-tag="">
                      <span tal:define="begin python:DateTime(begEndTimes[0].timeTime()+86400).ISO();
                                        end python:DateTime(begEndTimes[1].strftime('%m/%d/%y')).ISO();
                                        pss python:modules['Products'].PythonScripts.standard" tal:omit-tag="">
                      <a href tal:attributes="href python:here.portal_url()+'/search?start:date=%s&start_usage=range:max&end:date=%s&end_usage=range:min'%(pss.url_quote(begin),pss.url_quote(end))">
                        <span tal:replace="python: day['day'] or default">&nbsp;</span>
                      </a>
                      </span>
                    </span>
                  </td>
                  </metal:block>
                  </metal:block>
                  <td tal:condition="not: day/event"
                                      tal:content="python: day['day'] or default"
                                      tal:attributes="class python:test(current.year()==year and current.month()==month and current.day()==int(day['day']), 'todaynoevent', '')">
                    &nbsp;
                  </td>
                </metal:block>
              </metal:block>
            </tr>

    </table>


    <!-- The sticky notes -->
    <metal:block tal:repeat="week weeks">
      <metal:block tal:define="days week">
        <metal:block tal:repeat="day days">
        <div class="day" 
             id="dummy"
             tal:attributes="id python:'day%d%0.2d%0.2d' % (year, month, day['day']) "
             tal:condition="day/event">
            <div class="date" tal:content="python:'%d-%0.2d-%0.2d' % (year, month, day['day'])">
              2001-04-11
            </div>
            <metal:block tal:repeat="anevent day/eventslist">
            <div class="appointment" tal:content="python: here.getEventString(event=anevent)">an event</div>
            </metal:block>
          </div>
        </metal:block>
      </metal:block>
    </metal:block>

</div>
