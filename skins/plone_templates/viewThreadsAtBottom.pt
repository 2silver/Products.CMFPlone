<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
      i18n:domain="plone">

<body>

<div metal:define-macro="discussionView"
     class="discussion"
     tal:define="userHasReplyPermission python:checkPermission('Reply to item', here);
                 portal_discussion portal/portal_discussion;
                 isDiscussionAllowed python:portal_discussion.isDiscussionAllowedFor(here);
                 userIsAnonymous isAnon;
                 hereTypeInfo python:request.get('this_typeinfo', here.getTypeInfo());
                 view_action python:hereTypeInfo.getActionById('view');
                 isViewTemplate python:template_id==view_action or view_action=='view';
                 ">
    <tal:allowed condition="python:isDiscussionAllowed and isViewTemplate">
        <tal:comments tal:define="count python:portal_discussion.getDiscussionFor(here).replyCount(here);
                                  collapsed python:count&gt;5;
                                  state_class python:test(collapsed, 'collapsed', '')">
            <form name="reply"
                  action=""
                  method="post"
                  tal:condition="userHasReplyPermission"
                  tal:attributes="action string:$here_url/discussion_reply_form">
    
                  <input class="standalone"
                         type="submit"
                         value="Add Comment"
                         i18n:attributes="value"
                         />
            </form>
            <form tal:condition="python:userIsAnonymous and not userHasReplyPermission"
                  tal:define="pss modules/Products/PythonScripts/standard"
                  tal:attributes="action python:'%s/login_form?came_from=%s' %
                                                (here.portal_url(),
                                                pss.url_quote(request['URL']))">
                <input class="standalone"
                       type="submit"
                       value="Log in to add comments"
                       i18n:attributes="value"
                       />
            </form>
            
            <a name="comments"> </a>
            <tal:getreplies repeat="reply python:portal.sort_modified_ascending(
                                          portal_discussion.getDiscussionFor(here).getReplies())">
                <div class="comment">
                    <h3>
                        <tal:block replace="structure portal/discussionitem_icon.gif"/>
                        <span tal:replace="reply/title_or_id">Comment title</span>
                    </h3>
                    <div class="documentByLine"
                         tal:define="anonymous_creator python:reply.Creator()=='Anonymous User'">
                        <span i18n:translate="label_comment_by">Posted by</span>
                        <span tal:content="reply/Creator"
                              tal:condition="not:anonymous_creator">Poster Name</span>
                        <span i18n:translate="label_anonymous_user"
                              tal:condition="anonymous_creator">Anonymous User</span>
                        <span i18n:translate="label_commented_at">at</span> 
                        <span tal:replace="python:portal.toLocalizedTime(reply.modified(),
                                                  long_format=1)">8/23/2001 12:40:44 PM</span>
                    </div>
                    <div class="commentBody"
                         tal:content="structure reply/CookedBody">
                         This is the body text of the comment.
                    </div>
                    <form name="reply"
                          action="discussion_reply_form"
                          method="post"
                          style="display: inline;"
                          tal:attributes="action string:${reply/absolute_url}/discussion_reply_form"
                          tal:condition="userHasReplyPermission">
                        <input class="standalone"
                               type="submit"
                               value="Reply"
                               i18n:attributes="value"
                               />
                    </form>
                    <form name="delete"
                          action=""
                          method="post"
                          style="display: inline;"
                          tal:condition="python:checkPermission('Manage portal', here)"
                          tal:attributes="action string:${reply/absolute_url}/deleteDiscussion">
                        <input class="destructive"
                               type="submit"
                               value="Remove"
                               i18n:attributes="value"
                               />
                    </form>
                    <div tal:define="replies python: here.getReplyReplies(reply)" tal:condition="replies">	
                        <div tal:repeat="lst replies"> 
                            <div class="comment" 
                                 tal:define="indent python:(lst['depth']+1)*20;
                                             lst_object nocall:lst/object" 
                                 tal:attributes="style string:margin-left: ${indent}px;"> 
                                <div class="body"> 
                                    <div class="content"> 	
                                        <h4>
                                            <tal:block replace="structure here/discussionitem_icon.gif"/>
                                            <span tal:replace="lst_object/Title">Comment title</span>
                                        </h4>
                                        <div class="documentByLine" 
                                             tal:define="anonymous_creator python:lst_object.Creator()=='Anonymous User'">
                                            <span i18n:translate="label_comment_by">Posted by</span>
                                            <span tal:content="lst_object/Creator"
                                                  tal:condition="not:anonymous_creator">Poster Name</span>
                                            <span i18n:translate="label_anonymous_user"
                                                  tal:condition="anonymous_creator">Anonymous User</span>
                                            <span i18n:translate="label_commented_at">at</span> 
                                            <span tal:replace="python:portal.toLocalizedTime(lst_object.modified(),
                                                          long_format=1)">8/23/2001 12:49:08 PM</span>													
                                        </div>
                                        <div style="margin-bottom:1em;margin-top:1em;" 
                                             tal:content="structure lst_object/CookedBody"> 
                                            This is the body text of the comment. 
                                        </div> 
                                        <form name="reply"
                                              action="discussion_reply_form"
                                              method="post"
                                              style="display: inline;"
                                              tal:condition="userHasReplyPermission" 
                                              tal:attributes="action string:${lst_object/absolute_url}/discussion_reply_form" >
                                            <input class="context" 
                                                   type="submit" 
                                                   value="Reply" 
                                                   i18n:attributes="value"
                                                   />
                                        
                                        </form>
                                        <form name="" 
                                              action="" 
                                              method="post"
                                              style="display: inline;"
                                              tal:condition="python:checkPermission('Manage portal', here)"
                                              tal:attributes="action string:${lst_object/absolute_url}/deleteDiscussion">
                                            <input class="destructive" 
                                                   type="submit" 
                                                   value="Remove"
                                                   i18n:attributes="value"
                                               />
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </tal:getreplies>
        </tal:comments>
    </tal:allowed>
</div>
</body>
</html>
