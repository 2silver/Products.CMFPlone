<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

    <metal:border fill-slot="head_slot">
      <tal:border define="dummy python:request.set('enable_border',1)" />
    </metal:border>

  <body>

    <div metal:fill-slot="main"
         tal:define="errors options/state/getErrors;">

      <h1 i18n:translate="heading_edit_properties">Edit Properties</h1>

      <p i18n:translate="description_edit_properties">
        This information, also referred to as <em>metadata</em> is the
        collection of information that is used to categorize an
        object, assign effectuation dates and expiration dates,
        language, and keywords.
      </p>


      <form name="edit_form"
            action=""
            method="post"
            tal:attributes="action string:${here/getId}/${template/getId}">

        <fieldset>

          <legend i18n:translate="legend_item_properties">
            Item Properties
          </legend>

          <div class="field">
            <label i18n:translate="label_allow_discussion">
              Allow Discussion on this item
            </label>

            <div class="formHelp" i18n:translate="help_allow_discussion">
              'Default' will use the site-wide setting for discussions.
            </div>

            <metal:block tal:define="val request/allowDiscussion | python: here.portal_discussion.isDiscussionAllowedFor(here);
                         val python:test(not hasattr(here,'allow_discussion'),None,val);
                         val python:test(val=='off',0,val);
                         val python:test(val=='on',1,val);
                         tabindex tabindex/next;">
              <input class="noborder"
                     type="radio"
                     name="allowDiscussion"
                     value="default"
                     tabindex=""
                     id="discussion_default"
                     tal:attributes="checked python:val is None;
                     tabindex tabindex;"
                     />
              <label for="discussion_default"
                     i18n:translate="label_discussion_default">
                Default
              </label>
              <br />

              <input class="noborder"
                     type="radio"
                     name="allowDiscussion"
                     value="on"
                     tabindex=""
                     id="discussion_on"
                     tal:attributes="checked python:test(val == 1, '1', None);
                     tabindex tabindex;"
                     />
              <label for="discussion_on"
                     i18n:translate="label_discussion_enabled">
                Enabled
              </label>
              <br />

              <input class="noborder"
                     type="radio"
                     name="allowDiscussion"
                     value="off"
                     tabindex=""
                     id="discussion_off"
                     tal:attributes="checked python:test(val == 0, '1', None);
                     tabindex tabindex;"
                     />
              <label for="discussion_off" i18n:translate="label_discussion_disabled">Disabled</label>


            </metal:block>
          </div>

          <div class="field">
            <label i18n:translate="label_keywords">Keywords</label>

            <div class="formHelp" i18n:translate="help_keyword">
              Keywords relate different types of content to each other.
              Don't select too many categories.
            </div>

            <div tal:define="global contentSubjects here/Subject;
                 global allowedSubjects python:here.portal_metadata.listAllowedSubjects(here);
                 global catalogSubjects python:here.portal_catalog.uniqueValuesFor('Subject');
                 global allowedSubjects python:list(here.unique(allowedSubjects+catalogSubjects));
                 dummy python:allowedSubjects.sort( lambda x,y: cmp(x,y) );">

              <tal:block tal:define="site_props here/portal_properties/site_properties;
                         allowRolesToAddKeywords site_props/allowRolesToAddKeywords"
                         tal:condition="python:[role for role in user.getRolesInContext(here) if role in allowRolesToAddKeywords]">

                <div style="width: 45%; float: right;">

                  <label for="entered_subjects" i18n:translate="label_new_keywords">New keywords</label>

                  <div class="formHelp" i18n:translate="help_new_keyword">
                    Each new keyword must be on a separate line.
                  </div>

                  <textarea id="entered_subjects"
                            name="subject:lines"
                            rows="11"
                            cols="15"
                            wrap="off"
                            tabindex=""
                            tal:attributes="tabindex tabindex/next;"
                            tal:define="subject python:request.get('subject',[])"
                            tal:content="python:'\n'.join(subject)"
                            >selected keywords</textarea>&nbsp;

                </div>
              </tal:block>

              <div style="width: 45%">
                <label for="predefined_subjects"
                       i18n:translate="label_existing_keywords">
                  Existing keywords
                </label>

                <div>
                </div>

                <select id="predefined_subjects"
                        name="predefined_subjects:list"
                        size="14"
                        multiple="multiple"
                        tabindex=""
                        tal:attributes="tabindex tabindex/next;">
                  <option value="#"
                          tal:repeat="subject allowedSubjects"
                          tal:content="subject"
                          tal:attributes="value subject;
                          selected python:test(subject in contentSubjects, 'selected', None)">
                    an existing keyword
                  </option>
                </select>

              </div>

            </div>

          </div>

          <div class="field"
               tal:define="error errors/effective_date | nothing;">

            <label for="effective_date"
                   i18n:translate="label_effective_date">
              Effective Date
            </label>

            <div class="formHelp" i18n:translate="help_effective_date">
              The date when the item will be available (of course it
              needs to be published too).  If no date is selected the
              item will be effective immediately.
            </div>

            <div tal:define="inputname  string:effective_date;
                 formname   string:edit_form;
                 formvalue  request/effective_date | nothing;
                 inputvalue python:test(here.effective_date, here.effective_date, '');
                 inputvalue python:test(formvalue,formvalue,inputvalue);
                 tabindex tabindex/next;"
                 tal:attributes="class python:test(error, 'field error', 'field')">

              <div tal:content="error">Validation error output</div>

              <div metal:use-macro="here/calendar_slot/macros/calendarDatePickerBox">
                Gets the calendar code.
              </div>
            </div>
          </div>

          <div class="field"
               tal:define="error errors/expiration_date | nothing;">

            <label for="expiration_date"
                   i18n:translate="label_expiration_date">
              Expiration Date
            </label>

            <div class="formHelp" i18n:translate="help_expiration_date">
              The date when the item expires.
              This will automatically make the item invisible for
              others at the given date.  If no date is chosen, it will
              never expire.
            </div>

            <div tal:define="inputname  string:expiration_date;
                 formname   string:edit_form;
                 formvalue  request/expiration_date | nothing;
                 inputvalue python:test(here.expiration_date, here.expiration_date, '');
                 inputvalue python:test(formvalue,formvalue,inputvalue);
                 tabindex tabindex/next;"
                 tal:attributes="class python:test(error, 'field error', 'field')">

              <div tal:content="error">Validation error output</div>

              <div metal:use-macro="here/calendar_slot/macros/calendarDatePickerBox">
                Gets the calendar code.
              </div>
            </div>
          </div>

          <div class="field">
            <label for="format"
                   i18n:translate="label_format">
              Format
            </label>

            <div class="formHelp" i18n:translate="help_format">
              The MIME-type of the item. If you don't know what this
              does, just leave it.
            </div>

            <select name="format"
                    id="format"
                    tabindex=""
                    tal:attributes="tabindex tabindex/next;"
                    tal:define="format request/format | here/Format;">
              <option value=""
                      i18n:translate="label_choose_mime">
                Choose MIME-type
              </option>
              <option tal:repeat="mimetype here/plone_utils/availableMIMETypes"
                      tal:attributes="value python:mimetype;
                      selected python:test(format == mimetype, 'selected', None);"
                      tal:content="mimetype" />
            </select>
          </div>

          <div class="field"
               tal:define="def_language here/portal_properties/site_properties/default_language;
               sel_language python:test(here.Language(), here.Language(), def_language);
               sel_language python:request.get('language',sel_language)">

            <label for="language"
                   i18n:translate="label_language">
              Language
            </label>

            <div class="formHelp" i18n:translate="help_language">
              The language of this item.
            </div>

            <div tal:define="available_languages python:list(here.availableLanguages());
                 sorted python:available_languages.sort( lambda x, y: cmp(x[1],y[1]) )">
              <!-- ISO-639-2 language selector for Plone -->
              <select name="language"
                      id="language"
                      tabindex=""
                      tal:attributes="tabindex tabindex/next;"
                      >
                <option value=""
                        i18n:translate="choose_language">
                  Choose Language
                </option>
                <option tal:repeat="language available_languages"
                        tal:attributes="value python:language[0];
                        selected python:test(sel_language == language[0], 'selected', None)"
                        tal:content="structure python:language[1]">
                  Language
                </option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="rights"
                   i18n:translate="label_copyrights">
              Copyrights
            </label>

            <div class="formHelp" i18n:translate="help_copyrights">
              The copyrights on this item.
            </div>

            <input type="text"
                   id="rights"
                   name="rights"
                   size="25"
                   value=""
                   tabindex=""
                   tal:attributes="value request/rights | here/Rights;
                   tabindex tabindex/next;"
                   />
          </div>

          <div class="field">
            <label for="contributors"
                   i18n:translate="label_contributors">
              Contributors
            </label>

            <div class="formHelp" i18n:translate="help_contributors">
              The names of people that have contributed to this item.
              Each contributor should be on a separate line.
            </div>

            <textarea name="contributors:lines"
                      id="contributors"
                      rows="5"
                      cols="25"
                      tabindex=""
                      tal:attributes="tabindex tabindex/next;"
                      tal:define="contributors request/contributors | here/Contributors;"
                      tal:content="python:'\n'.join(contributors)"
            >contributors</textarea>
          </div>

          <div class="formControls"
               tal:define="process_creation request/process_creation|nothing;">
            <input class="context"
                   tabindex=""
                   type="submit"
                   name="form.button.Save"
                   value="Save"
                   i18n:attributes="value"
                   tal:attributes="tabindex tabindex/next;" />

            <input class="standalone"
                   tabindex=""
                   type="submit"
                   name="form.button.Cancel"
                   value="Cancel"
                   i18n:attributes="value"
                   tal:attributes="tabindex tabindex/next;" />
          </div>
        </fieldset>

        <input type="hidden" name="form.submitted" value="1" />

      </form>

    </div>

  </body>
</html>

